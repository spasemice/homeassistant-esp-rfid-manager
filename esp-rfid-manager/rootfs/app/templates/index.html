<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP-RFID Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .device-card {
            transition: all 0.3s ease;
        }
        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-online {
            color: #198754;
        }
        .status-offline {
            color: #dc3545;
        }
        .log-entry {
            font-size: 0.9rem;
            border-left: 3px solid #dee2e6;
            padding-left: 10px;
            margin-bottom: 8px;
        }
        .log-entry.access-granted {
            border-left-color: #198754;
        }
        .log-entry.access-denied {
            border-left-color: #dc3545;
        }
        .card-registration {
            border: 2px dashed #ffc107;
            background-color: #fff3cd;
        }
        .real-time-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #198754;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shield-lock"></i> ESP-RFID Manager
            </a>
            <div class="d-flex align-items-center">
                <div class="real-time-indicator me-2"></div>
                <small class="text-light">Live Updates</small>
                {% if ha_user %}
                <div class="dropdown ms-3">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle"></i> {{ ha_user.name }}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><h6 class="dropdown-header">{{ ha_user.name }}</h6></li>
                        <li><span class="dropdown-item-text small text-muted">
                            {% if ha_user.is_admin %}Admin User{% else %}Standard User{% endif %}
                        </span></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout">
                            <i class="bi bi-box-arrow-right"></i> Logout
                        </a></li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Devices Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <h4><i class="bi bi-router"></i> ESP-RFID Devices</h4>
                <div id="devices-container" class="row">
                    <!-- Devices will be loaded here -->
                </div>
            </div>
        </div>



        <div class="row">
            <!-- Users Management -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-people"></i> User Management</h5>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                <i class="bi bi-person-plus"></i> Add User
                            </button>
                            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#bulkAssignModal" onclick="loadBulkAssignDevices()">
                                <i class="bi bi-people-fill"></i> Bulk Assign
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <select id="device-filter" class="form-select">
                                <option value="">All Devices</option>
                            </select>
                        </div>
                        <div id="users-table-container">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>UID</th>
                                        <th>Device</th>
                                        <th>Access</th>
                                        <th>Valid Until</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Access Logs -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-clock-history"></i> Recent Access Logs</h5>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-house-gear"></i> Home Assistant
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/api/homeassistant/config" target="_blank">
                                    <i class="bi bi-download"></i> Download Config YAML
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="showHACardGenerator()">
                                    <i class="bi bi-layout-text-window-reverse"></i> Generate Card Template
                                </a></li>
                                <li><a class="dropdown-item" href="/api/homeassistant/user-doors?username=admin" target="_blank">
                                    <i class="bi bi-person-check"></i> Check User Door Access
                                </a></li>
                                <li><a class="dropdown-item" href="/api/homeassistant/access-history?limit=20" target="_blank">
                                    <i class="bi bi-clock-history"></i> View Access History API
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><span class="dropdown-item-text text-muted small">
                                    Auto-discovery via MQTT enabled
                                </span></li>
                                <li><span class="dropdown-item-text text-muted small">
                                    Button entities for door unlock
                                </span></li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="access-logs">
                            <!-- Logs will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Events Log -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-list-ul"></i> System Events</h5>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <div id="system-events">
                            <!-- Events will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label for="userName" class="form-label">User Name</label>
                            <div class="input-group">
                                <select class="form-select" id="userName" required>
                                    <option value="">Select Home Assistant User</option>
                                    <!-- HA users will be loaded here -->
                                </select>
                                <button class="btn btn-outline-secondary" type="button" onclick="toggleManualEntry()" title="Enter custom username">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </div>
                            <input type="text" class="form-control d-none" id="userNameManual" placeholder="Enter custom username">
                        </div>
                        <div class="mb-3">
                            <label for="userUID" class="form-label">Card UID</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="userUID" required placeholder="Scan a card or enter UID manually">
                                <span class="input-group-text">
                                    <i class="bi bi-credit-card" title="Scan a card on any ESP-RFID device"></i>
                                </span>
                            </div>
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i> 
                                <span id="cardDetectionStatus" class="text-muted">Card detection disabled</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Select Doors/Devices</label>
                            <div id="userDevicesList" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                <!-- Device checkboxes will be loaded here -->
                            </div>
                            <div class="form-text">Select one or more devices/doors for this user</div>
                        </div>
                        <div class="mb-3">
                            <label for="userAccess" class="form-label">Access Type</label>
                            <select class="form-select" id="userAccess">
                                <option value="1">Always</option>
                                <option value="0">Disabled</option>
                                <option value="99">Admin</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="validFrom" class="form-label">Valid From</label>
                                <input type="datetime-local" class="form-control" id="validFrom">
                            </div>
                            <div class="col-md-6">
                                <label for="validUntil" class="form-label">Valid Until</label>
                                <input type="datetime-local" class="form-control" id="validUntil">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addUser()">Add User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Card Registration Modal -->
    <div class="modal fade" id="cardRegistrationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Register New Card</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Card UID:</strong> <span id="cardUID"></span><br>
                        <strong>Device:</strong> <span id="cardDevice"></span>
                    </div>
                    <form id="cardRegistrationForm">
                        <div class="mb-3">
                            <label for="cardUserName" class="form-label">User Name</label>
                            <input type="text" class="form-control" id="cardUserName" required>
                        </div>
                        <div class="mb-3">
                            <label for="cardUserAccess" class="form-label">Access Type</label>
                            <select class="form-select" id="cardUserAccess">
                                <option value="1">Always</option>
                                <option value="0">Disabled</option>
                                <option value="99">Admin</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="cardValidFrom" class="form-label">Valid From</label>
                                <input type="datetime-local" class="form-control" id="cardValidFrom">
                            </div>
                            <div class="col-md-6">
                                <label for="cardValidUntil" class="form-label">Valid Until</label>
                                <input type="datetime-local" class="form-control" id="cardValidUntil">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="registerCard()">Register Card</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <div class="mb-3">
                            <label for="editUserName" class="form-label">User Name</label>
                            <input type="text" class="form-control" id="editUserName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editUserUID" class="form-label">Card UID</label>
                            <input type="text" class="form-control" id="editUserUID" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editUserDevice" class="form-label">Device</label>
                            <input type="text" class="form-control" id="editUserDevice" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editUserAccess" class="form-label">Access Type</label>
                            <select class="form-select" id="editUserAccess">
                                <option value="1">Always</option>
                                <option value="0">Disabled</option>
                                <option value="99">Admin</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="editValidFrom" class="form-label">Valid From</label>
                                <input type="datetime-local" class="form-control" id="editValidFrom">
                            </div>
                            <div class="col-md-6">
                                <label for="editValidUntil" class="form-label">Valid Until</label>
                                <input type="datetime-local" class="form-control" id="editValidUntil">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateUser()">Update User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Assign User Modal -->
    <div class="modal fade" id="bulkAssignModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign User to Multiple Doors</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bulkAssignForm">
                        <div class="mb-3">
                            <label for="bulkUserName" class="form-label">User Name</label>
                            <input type="text" class="form-control" id="bulkUserName" required>
                        </div>
                        <div class="mb-3">
                            <label for="bulkUserUID" class="form-label">Card UID</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="bulkUserUID" required placeholder="Scan a card or enter UID manually">
                                <span class="input-group-text">
                                    <i class="bi bi-credit-card" title="Scan a card on any ESP-RFID device"></i>
                                </span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Select Doors/Devices</label>
                            <div id="bulkDevicesList" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                <!-- Device checkboxes will be loaded here -->
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="bulkUserAccess" class="form-label">Access Type</label>
                            <select class="form-select" id="bulkUserAccess">
                                <option value="1">Always</option>
                                <option value="0">Disabled</option>
                                <option value="99">Admin</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="bulkValidFrom" class="form-label">Valid From</label>
                                <input type="datetime-local" class="form-control" id="bulkValidFrom">
                            </div>
                            <div class="col-md-6">
                                <label for="bulkValidUntil" class="form-label">Valid Until</label>
                                <input type="datetime-local" class="form-control" id="bulkValidUntil">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="bulkAssignUser()">Assign to Selected Doors</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete User Modal with Device Selection -->
    <div class="modal fade" id="deleteUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Delete User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Warning:</strong> This will permanently remove the user from selected devices.
                    </div>
                    <div id="deleteUserInfo">
                        <!-- User info will be loaded here -->
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Select devices to remove user from:</label>
                        <div id="deleteUserDevices">
                            <!-- Device checkboxes will be loaded here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteUser()">
                        <i class="bi bi-trash"></i> Delete User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Device Modal -->
    <div class="modal fade" id="deleteDeviceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Delete Offline Device</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>Danger:</strong> This will permanently delete the device and all associated users!
                    </div>
                    <div id="deleteDeviceInfo">
                        <!-- Device info will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteDevice()">
                        <i class="bi bi-trash"></i> Delete Device
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Permissions Modal -->
    <div class="modal fade" id="userPermissionsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">User Access Permissions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Access Control Grid:</strong> Configure which doors this user can access on each device.
                    </div>
                    <div id="userPermissionsInfo" class="mb-3">
                        <!-- User info will be loaded here -->
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-light">
                                <tr id="permissionsTableHeader">
                                    <th style="min-width: 120px;">Device / Door</th>
                                    <!-- Door column headers will be loaded here -->
                                </tr>
                            </thead>
                            <tbody id="permissionsTableBody">
                                <!-- Permissions grid will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>Bulk Actions:</h6>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-success" onclick="setAllPermissions(true)">
                                    <i class="bi bi-check-all"></i> Allow All
                                </button>
                                <button class="btn btn-danger" onclick="setAllPermissions(false)">
                                    <i class="bi bi-x-lg"></i> Deny All
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Legend:</h6>
                            <span class="badge bg-success me-2">
                                <i class="bi bi-check"></i> Allowed
                            </span>
                            <span class="badge bg-danger me-2">
                                <i class="bi bi-x"></i> Denied
                            </span>
                            <span class="badge bg-secondary">
                                <i class="bi bi-wifi-off"></i> Offline
                            </span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveUserPermissions()">
                        <i class="bi bi-shield-check"></i> Save Permissions
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- HA Card Template Modal -->
    <div class="modal fade" id="haCardModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Home Assistant Card Generator</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Select Devices:</h6>
                            <div id="haCardDevices">
                                <!-- Device checkboxes will be loaded here -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Card Type:</h6>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="cardType" id="cardTypeGrid" value="grid" checked>
                                    <label class="form-check-label" for="cardTypeGrid">
                                        Grid Cards
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="cardType" id="cardTypeEntities" value="entities">
                                    <label class="form-check-label" for="cardTypeEntities">
                                        Entity List
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="cardType" id="cardTypeHistory" value="history">
                                    <label class="form-check-label" for="cardTypeHistory">
                                        History Graph
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-success" onclick="generateHACard()">
                            <i class="bi bi-gear"></i> Generate Card
                        </button>
                    </div>
                    
                    <div class="mt-3">
                        <label for="generatedCard" class="form-label">Generated Card Configuration:</label>
                        <textarea class="form-control" id="generatedCard" rows="12" readonly 
                                  placeholder="Click 'Generate Card' to create Home Assistant card configuration..."></textarea>
                        <div class="mt-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="copyCardToClipboard()">
                                <i class="bi bi-clipboard"></i> Copy to Clipboard
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        // Detect if we're running in Home Assistant ingress iframe
        const isInIngress = window.location.pathname.includes('/api/hassio_ingress/') || 
                           window.parent !== window;
        
        // Get the correct base URL for API calls
        let apiBaseUrl = '';
        let socketioPath = '/socket.io/';
        
        if (isInIngress) {
            // Extract the ingress path from current URL
            const pathname = window.location.pathname;
            if (pathname.includes('/api/hassio_ingress/')) {
                // Format: /api/hassio_ingress/TOKEN/
                apiBaseUrl = pathname.split('/api/hassio_ingress/')[1];
                if (apiBaseUrl) {
                    apiBaseUrl = '/api/hassio_ingress/' + apiBaseUrl.split('/')[0];
                    socketioPath = apiBaseUrl + '/socket.io/';
                }
            }
        }
        
        console.log('Ingress detection:', { isInIngress, apiBaseUrl, socketioPath });
        
        // Initialize Socket.IO with correct path
        const socket = io(window.location.origin, {
            path: socketioPath,
            transports: ['polling', 'websocket']
        });
        let currentRegistrationId = null;
        
        // Helper function to get correct API URL
        function getApiUrl(endpoint) {
            return apiBaseUrl + endpoint;
        }

        // Utility function for showing alerts
        function showAlert(message, type = 'info') {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Add to body
            document.body.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Socket event handlers
        socket.on('connect', function() {
            console.log('Connected to server');
        });

        socket.on('access_event', function(data) {
            addAccessLog(data);
        });

        socket.on('new_card_detected', function(data) {
            const uid = data.uid;
            const hostname = data.hostname;
            
            // Check if Add User modal is open
            const addUserModal = document.getElementById('addUserModal');
            if (addUserModal && addUserModal.classList.contains('show')) {
                // Auto-fill the UID field
                document.getElementById('userUID').value = uid;
                
                // Auto-check the device if available - try both naming conventions
                let deviceCheckbox = document.getElementById(`userDevice_${hostname}`);
                if (!deviceCheckbox) {
                    deviceCheckbox = document.getElementById(`device_${hostname}`);
                }
                if (deviceCheckbox) {
                    deviceCheckbox.checked = true;
                }
                
                // Show success feedback
                const uidField = document.getElementById('userUID');
                uidField.classList.add('bg-success', 'bg-opacity-25');
                setTimeout(() => {
                    uidField.classList.remove('bg-success', 'bg-opacity-25');
                }, 2000);
                
                // Check if card is already registered to another user
                checkCardDuplicate(uid);
            }
            
            // Also handle for bulk assign modal
            const bulkModal = document.getElementById('bulkAssignModal');
            if (bulkModal && bulkModal.classList.contains('show')) {
                document.getElementById('bulkUserUID').value = uid;
                
                // Auto-check the device if available
                let deviceCheckbox = document.getElementById(`device_${hostname}`);
                if (deviceCheckbox) {
                    deviceCheckbox.checked = true;
                }
                
                // Show success feedback
                const uidField = document.getElementById('bulkUserUID');
                uidField.classList.add('bg-success', 'bg-opacity-25');
                setTimeout(() => {
                    uidField.classList.remove('bg-success', 'bg-opacity-25');
                }, 2000);
            }
        });

        socket.on('mqtt_message', function(data) {
            addSystemEvent(data);
        });

        // Handle card scan results (log format)
        socket.on('card_scan_result', function(data) {
            console.log('Card scan result:', data);
            
            const uid = data.uid;
            const username = data.username;
            const isRegistered = data.is_registered;
            
            // Handle for Add User modal
            const addUserModal = document.getElementById('addUserModal');
            if (addUserModal && addUserModal.classList.contains('show')) {
                document.getElementById('userUID').value = uid;
                
                // Auto-check the device if available - try both naming conventions
                let deviceCheckbox = document.getElementById(`userDevice_${data.hostname}`);
                if (!deviceCheckbox) {
                    deviceCheckbox = document.getElementById(`device_${data.hostname}`);
                }
                if (deviceCheckbox) {
                    deviceCheckbox.checked = true;
                }
                
                // Show different feedback based on registration status
                const uidField = document.getElementById('userUID');
                if (isRegistered) {
                    uidField.classList.add('bg-warning', 'bg-opacity-25');
                    showAlert(`⚠️ Card ${uid} is already registered to user "${username}" on device ${data.hostname}`, 'warning');
                } else {
                    uidField.classList.add('bg-success', 'bg-opacity-25');
                    showAlert(`✅ New card ${uid} detected on ${data.hostname}`, 'success');
                }
                
                setTimeout(() => {
                    uidField.classList.remove('bg-warning', 'bg-success', 'bg-opacity-25');
                }, 3000);
            }
            
            // Handle for Bulk Assign modal
            const bulkModal = document.getElementById('bulkAssignModal');
            if (bulkModal && bulkModal.classList.contains('show')) {
                document.getElementById('bulkUserUID').value = uid;
                
                const uidField = document.getElementById('bulkUserUID');
                if (isRegistered) {
                    uidField.classList.add('bg-warning', 'bg-opacity-25');
                    alert(`Card already registered to: ${username} on ${data.hostname}`);
                } else {
                    uidField.classList.add('bg-success', 'bg-opacity-25');
                }
                
                setTimeout(() => {
                    uidField.classList.remove('bg-warning', 'bg-success', 'bg-opacity-25');
                }, 3000);
            }
        });

        // Delete device
        let currentDeleteDeviceHostname = null;
        
        function deleteDevice(hostname, status) {
            if (status === 'online') {
                alert('Cannot delete online device. Please wait for the device to go offline first.');
                return;
            }
            
            currentDeleteDeviceHostname = hostname;
            
            // Populate device info
            document.getElementById('deleteDeviceInfo').innerHTML = `
                <p><strong>Device:</strong> ${hostname}</p>
                <p><strong>Status:</strong> ${status}</p>
                <p class="text-muted">This will also delete all users associated with this device from the local database.</p>
            `;
            
            // Show modal
            new bootstrap.Modal(document.getElementById('deleteDeviceModal')).show();
        }
        
        function confirmDeleteDevice() {
            if (!currentDeleteDeviceHostname) return;
            
            fetch(getApiUrl(`/api/devices/${currentDeleteDeviceHostname}`), {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert(`Device deleted successfully!\n${result.users_deleted} users were also removed.`);
                    bootstrap.Modal.getInstance(document.getElementById('deleteDeviceModal')).hide();
                    loadDevices();
                    loadUsers();
                }
            })
            .catch(error => {
                console.error('Error deleting device:', error);
                alert('Error deleting device');
            });
        }

        // HA Card Generator
        function showHACardGenerator() {
            // Load devices for selection
            fetch(getApiUrl('/api/devices'))
                .then(response => response.json())
                .then(devices => {
                    let devicesHtml = '';
                    devices.forEach(device => {
                        const statusIcon = device.status === 'online' ? 
                            '<i class="bi bi-circle-fill text-success"></i>' : 
                            '<i class="bi bi-circle-fill text-danger"></i>';
                        
                        devicesHtml += `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="haCard_${device.hostname}" value="${device.hostname}">
                                <label class="form-check-label" for="haCard_${device.hostname}">
                                    ${statusIcon} ${device.hostname}
                                </label>
                            </div>
                        `;
                    });
                    
                    document.getElementById('haCardDevices').innerHTML = devicesHtml;
                    new bootstrap.Modal(document.getElementById('haCardModal')).show();
                })
                .catch(error => {
                    console.error('Error loading devices:', error);
                    alert('Error loading devices');
                });
        }

        function generateHACard() {
            // Get selected devices
            const selectedDevices = [];
            const checkboxes = document.querySelectorAll('#haCardDevices input[type="checkbox"]:checked');
            checkboxes.forEach(cb => selectedDevices.push(cb.value));
            
            if (selectedDevices.length === 0) {
                alert('Please select at least one device');
                return;
            }
            
            // Get selected card type
            const cardType = document.querySelector('input[name="cardType"]:checked').value;
            
            fetch(getApiUrl('/api/homeassistant/card-template'), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    devices: selectedDevices,
                    type: cardType
                })
            })
            .then(response => response.json())
            .then(cardConfig => {
                // Convert to YAML-like format
                const yamlString = JSON.stringify(cardConfig, null, 2);
                document.getElementById('generatedCard').value = yamlString;
            })
            .catch(error => {
                console.error('Error generating card:', error);
                alert('Error generating card');
            });
        }

        function copyCardToClipboard() {
            const cardText = document.getElementById('generatedCard').value;
            if (!cardText) {
                alert('Generate a card first');
                return;
            }
            
            navigator.clipboard.writeText(cardText).then(() => {
                showAlert('✅ Card configuration copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Error copying to clipboard:', err);
                alert('Error copying to clipboard');
            });
        }

        // User Permissions Functions
        let currentUserPermissions = null;

        function editUserPermissions(userId) {
            fetch(getApiUrl(`/api/users/${userId}/permissions`))
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    currentUserPermissions = data;
                    
                    // Set user info
                    document.getElementById('userPermissionsInfo').innerHTML = `
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <strong>${data.user.username}</strong> 
                                <span class="text-muted">UID: ${data.user.uid}</span>
                            </div>
                        </div>
                    `;
                    
                    // Build permissions grid
                    buildPermissionsGrid(data);
                    
                    new bootstrap.Modal(document.getElementById('userPermissionsModal')).show();
                })
                .catch(error => {
                    console.error('Error loading user permissions:', error);
                    alert('Error loading user permissions: ' + error.message);
                });
        }

        function buildPermissionsGrid(data) {
            const doors = ['main', 'front', 'back', 'side'];
            
            // Build header - append to existing first column
            let headerHtml = '<th style="min-width: 120px;">Device / Door</th>';
            doors.forEach(door => {
                headerHtml += `<th class="text-center text-capitalize">${door} Door</th>`;
            });
            document.getElementById('permissionsTableHeader').innerHTML = headerHtml;
            
            // Build rows
            let bodyHtml = '';
            data.devices.forEach(device => {
                bodyHtml += `
                    <tr>
                        <td>
                            <strong>${device.hostname}</strong><br>
                            <small class="text-muted">${device.ip_address}</small><br>
                            <span class="badge bg-${device.status === 'online' ? 'success' : 'secondary'} badge-sm">
                                ${device.status}
                            </span>
                        </td>
                `;
                
                doors.forEach(door => {
                    const key = `${device.hostname}:${door}`;
                    const perm = data.permissions[key];
                    const isAllowed = perm ? perm.can_access : true;
                    const isDisabled = device.status === 'offline';
                    
                    bodyHtml += `
                        <td class="text-center">
                            <div class="form-check form-switch d-flex justify-content-center">
                                <input class="form-check-input permission-switch" 
                                       type="checkbox" 
                                       data-device="${device.hostname}" 
                                       data-door="${door}"
                                       ${isAllowed ? 'checked' : ''} 
                                       ${isDisabled ? 'disabled' : ''}>
                            </div>
                        </td>
                    `;
                });
                
                bodyHtml += '</tr>';
            });
            
            document.getElementById('permissionsTableBody').innerHTML = bodyHtml;
        }

        function setAllPermissions(allow) {
            const switches = document.querySelectorAll('.permission-switch:not([disabled])');
            switches.forEach(sw => {
                sw.checked = allow;
            });
        }

        function saveUserPermissions() {
            if (!currentUserPermissions) {
                alert('No user permissions data loaded');
                return;
            }
            
            const permissions = {};
            const switches = document.querySelectorAll('.permission-switch');
            
            switches.forEach(sw => {
                const device = sw.dataset.device;
                const door = sw.dataset.door;
                const key = `${device}:${door}`;
                
                permissions[key] = {
                    can_access: sw.checked,
                    access_type: 'permanent',
                    valid_from: 0,
                    valid_until: 0
                };
            });
            
            fetch(getApiUrl(`/api/users/${currentUserPermissions.user.id}/permissions`), {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ permissions })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                if (result.error) {
                    throw new Error(result.error);
                }
                if (result.message) {
                    showAlert('✅ ' + result.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('userPermissionsModal')).hide();
                    loadUsers(); // Refresh users list
                } else {
                    alert('Unexpected response: ' + JSON.stringify(result));
                }
            })
            .catch(error => {
                console.error('Error saving permissions:', error);
                alert('Error saving permissions: ' + error.message);
            });
        }

        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadDevices();
            loadUsers();
            loadAccessLogs();
            
            // Set default datetime values
            const now = new Date();
            const nextYear = new Date(now.getTime() + 365 * 24 * 60 * 60 * 1000);
            document.getElementById('validFrom').value = now.toISOString().slice(0, 16);
            document.getElementById('validUntil').value = nextYear.toISOString().slice(0, 16);
        });

        // Load devices
        function loadDevices() {
            fetch(getApiUrl('/api/devices'))
                .then(response => response.json())
                .then(devices => {
                    const container = document.getElementById('devices-container');
                    const deviceFilter = document.getElementById('device-filter');
                    const userDevicesList = document.getElementById('userDevicesList');
                    
                    container.innerHTML = '';
                    deviceFilter.innerHTML = '<option value="">All Devices</option>';
                    userDevicesList.innerHTML = '';
                    
                    devices.forEach(device => {
                        // Device card - Compact layout
                        const deviceCard = document.createElement('div');
                        deviceCard.className = 'col-lg-6 col-xl-4 mb-3';
                        deviceCard.innerHTML = `
                            <div class="card device-card h-100">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="flex-grow-1 min-w-0">
                                            <h6 class="card-title mb-1 text-truncate">${device.hostname}</h6>
                                            <p class="card-text text-muted mb-0 small">${device.ip_address}</p>
                                        </div>
                                        <span class="badge ${device.status === 'online' ? 'bg-success' : 'bg-secondary'} ms-2 flex-shrink-0">
                                            ${device.status}
                                        </span>
                                    </div>
                                    <small class="text-muted d-block mb-2">Last: ${new Date(device.last_seen).toLocaleString()}</small>
                                    <div class="d-flex gap-1">
                                        ${device.status === 'offline' ? 
                                                                                        `<button class="btn btn-danger btn-sm flex-fill" onclick="deleteDevice('${device.hostname}', '${device.status}')" title="Delete Offline Device">
                                                 <i class="bi bi-trash"></i> Delete
                                             </button>` : 
                                            `<button class="btn btn-primary btn-sm" onclick="openDoor('${device.hostname}')" title="Open Door">
                                                <i class="bi bi-door-open"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="refreshUsers('${device.hostname}')" title="Sync Users">
                                                <i class="bi bi-arrow-clockwise"></i> Sync
                                            </button>`
                                        }
                                    </div>
                                </div>
                            </div>
                        `;
                        container.appendChild(deviceCard);
                        
                        // Add to filters
                        // Add to filter dropdown
                        const filterOption = document.createElement('option');
                        filterOption.value = device.hostname;
                        filterOption.textContent = device.hostname;
                        deviceFilter.appendChild(filterOption);
                        
                        // Add to user devices checkboxes
                        const deviceCheckbox = document.createElement('div');
                        deviceCheckbox.className = 'form-check';
                        deviceCheckbox.innerHTML = `
                            <input class="form-check-input" type="checkbox" value="${device.hostname}" id="userDevice_${device.hostname}">
                            <label class="form-check-label" for="userDevice_${device.hostname}">
                                <strong>${device.hostname}</strong> 
                                <small class="text-muted">(${device.ip_address})</small>
                                <span class="badge ${device.status === 'online' ? 'bg-success' : 'bg-danger'} ms-2">${device.status}</span>
                            </label>
                        `;
                        userDevicesList.appendChild(deviceCheckbox);
                    });
                })
                .catch(error => console.error('Error loading devices:', error));
        }

        // Load users
        function loadUsers() {
            const deviceFilter = document.getElementById('device-filter').value;
            const url = deviceFilter ? `/api/users?device=${deviceFilter}` : '/api/users';
            
            fetch(getApiUrl(url))
                .then(response => response.json())
                .then(users => {
                    const tbody = document.getElementById('users-table');
                    tbody.innerHTML = '';
                    
                    users.forEach(user => {
                        const row = document.createElement('tr');
                        const validUntil = user.valid_until ? new Date(user.valid_until * 1000).toLocaleDateString() : 'Never';
                        const accessType = user.acctype === 99 ? 'Admin' : user.acctype === 1 ? 'Always' : 'Disabled';
                        
                        row.innerHTML = `
                            <td>${user.username}</td>
                            <td><code>${user.uid}</code></td>
                            <td>${user.device_hostname}</td>
                            <td><span class="badge ${user.acctype === 1 ? 'bg-success' : user.acctype === 99 ? 'bg-warning' : 'bg-secondary'}">${accessType}</span></td>
                            <td>${validUntil}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="editUser(${user.id})" title="Edit User">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-success" onclick="editUserPermissions(${user.id})" title="Edit Permissions">
                                        <i class="bi bi-shield-check"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteUser(${user.id})" title="Delete User">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error loading users:', error));
        }

        // Load access logs
        function loadAccessLogs() {
            fetch(getApiUrl('/api/access-logs?limit=20'))
                .then(response => response.json())
                .then(logs => {
                    const container = document.getElementById('access-logs');
                    container.innerHTML = '';
                    
                    logs.forEach(log => {
                        addAccessLog(log);
                    });
                })
                .catch(error => console.error('Error loading access logs:', error));
        }

        // Add access log entry
        function addAccessLog(log) {
            const container = document.getElementById('access-logs');
            const logEntry = document.createElement('div');
            const isGranted = log.access_type && !log.access_type.includes('Denied');
            
            logEntry.className = `log-entry ${isGranted ? 'access-granted' : 'access-denied'}`;
            logEntry.innerHTML = `
                <div class="d-flex justify-content-between">
                    <strong>${log.username} (${log.uid})</strong>
                    <small>${new Date(log.timestamp).toLocaleString()}</small>
                </div>
                <div>
                    <span class="badge ${isGranted ? 'bg-success' : 'bg-danger'}">${log.access_type}</span>
                    <small class="text-muted">on ${log.device_hostname} - ${log.door_name}</small>
                </div>
            `;
            
            container.insertBefore(logEntry, container.firstChild);
            
            // Keep only last 20 entries
            while (container.children.length > 20) {
                container.removeChild(container.lastChild);
            }
        }



        // Show card registration modal
        function showCardRegistrationModal(id, uid, hostname) {
            currentRegistrationId = id;
            document.getElementById('cardUID').textContent = uid;
            document.getElementById('cardDevice').textContent = hostname;
            
            // Set default datetime values
            const now = new Date();
            const nextYear = new Date(now.getTime() + 365 * 24 * 60 * 60 * 1000);
            document.getElementById('cardValidFrom').value = now.toISOString().slice(0, 16);
            document.getElementById('cardValidUntil').value = nextYear.toISOString().slice(0, 16);
            
            new bootstrap.Modal(document.getElementById('cardRegistrationModal')).show();
        }

        // Register card
        function registerCard() {
            const username = document.getElementById('cardUserName').value;
            const acctype = document.getElementById('cardUserAccess').value;
            const validFrom = document.getElementById('cardValidFrom').value;
            const validUntil = document.getElementById('cardValidUntil').value;
            
            if (!username) {
                alert('Please enter a username');
                return;
            }
            
            const data = {
                username: username,
                acctype: parseInt(acctype),
                valid_since: validFrom ? Math.floor(new Date(validFrom).getTime() / 1000) : 0,
                valid_until: validUntil ? Math.floor(new Date(validUntil).getTime() / 1000) : 0
            };
            
            fetch(getApiUrl(`/api/card-registrations/${currentRegistrationId}`), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    bootstrap.Modal.getInstance(document.getElementById('cardRegistrationModal')).hide();
                    loadUsers();
                    loadCardRegistrations();
                    alert('Card registered successfully!');
                }
            })
            .catch(error => {
                console.error('Error registering card:', error);
                alert('Error registering card');
            });
        }



        // Show alert notification
        function showAlert(message, type = 'info') {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Add to body
            document.body.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Check if card is already registered
        function checkCardDuplicate(uid) {
            fetch(getApiUrl(`/api/users?uid=${encodeURIComponent(uid)}`))
                .then(response => response.json())
                .then(users => {
                    if (users.length > 0) {
                        const user = users[0];
                        const warningDiv = document.getElementById('cardDuplicateWarning') || createCardWarningDiv();
                        warningDiv.innerHTML = `
                            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                                <strong>Warning:</strong> This card is already registered to user <strong>${user.username}</strong> on device <strong>${user.device_hostname}</strong>.
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        `;
                        warningDiv.classList.remove('d-none');
                    } else {
                        const warningDiv = document.getElementById('cardDuplicateWarning');
                        if (warningDiv) {
                            warningDiv.classList.add('d-none');
                        }
                    }
                })
                .catch(error => console.error('Error checking card duplicate:', error));
        }

        // Create card warning div if it doesn't exist
        function createCardWarningDiv() {
            const warningDiv = document.createElement('div');
            warningDiv.id = 'cardDuplicateWarning';
            warningDiv.className = 'd-none';
            
            const uidField = document.getElementById('userUID');
            uidField.parentNode.insertBefore(warningDiv, uidField.nextSibling);
            
            return warningDiv;
        }

        // Show warning when card is already registered
        function showCardAlreadyRegisteredWarning(username, hostname) {
            const warningDiv = document.getElementById('cardDuplicateWarning') || createCardWarningDiv();
            warningDiv.innerHTML = `
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <strong>Card Already Registered!</strong> This card belongs to user <strong>${username}</strong> on device <strong>${hostname}</strong>.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            warningDiv.classList.remove('d-none');
        }

        // Add user
        function addUser() {
            const username = getSelectedUsername();
            const uid = document.getElementById('userUID').value;
            const acctype = document.getElementById('userAccess').value;
            const validFrom = document.getElementById('validFrom').value;
            const validUntil = document.getElementById('validUntil').value;
            
            // Get selected devices
            const selectedDevices = [];
            const checkboxes = document.querySelectorAll('#userDevicesList input[type="checkbox"]:checked');
            checkboxes.forEach(cb => selectedDevices.push(cb.value));
            
            if (!username || !uid || selectedDevices.length === 0) {
                alert('Please fill in all required fields and select at least one device');
                return;
            }
            
            const data = {
                username: username,
                uid: uid,
                devices: selectedDevices,
                acctype: parseInt(acctype),
                valid_since: validFrom ? Math.floor(new Date(validFrom).getTime() / 1000) : 0,
                valid_until: validUntil ? Math.floor(new Date(validUntil).getTime() / 1000) : 0
            };
            
            fetch(getApiUrl('/api/users'), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.results) {
                    let successCount = 0;
                    let errorCount = 0;
                    let message = 'User assignment results:\n\n';
                    
                    result.results.forEach(res => {
                        if (res.status === 'success') {
                            successCount++;
                            message += `✓ ${res.device}: ${res.message}\n`;
                        } else {
                            errorCount++;
                            message += `✗ ${res.device}: ${res.message}\n`;
                        }
                    });
                    
                    message += `\nSummary: ${successCount} successful, ${errorCount} failed`;
                    alert(message);
                    
                    if (successCount > 0) {
                        bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                        document.getElementById('addUserForm').reset();
                        // Uncheck all checkboxes
                        document.querySelectorAll('#userDevicesList input[type="checkbox"]').forEach(cb => cb.checked = false);
                        loadUsers();
                    }
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error adding user:', error);
                alert('Error adding user');
            });
        }

        // Delete user with device selection
        let currentDeleteUserId = null;
        
        function deleteUser(userId) {
            currentDeleteUserId = userId;
            
            // Load user info and devices
            fetch(getApiUrl(`/api/users/${userId}/devices`))
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                        return;
                    }
                    
                    // Populate user info
                    document.getElementById('deleteUserInfo').innerHTML = `
                        <p><strong>User:</strong> ${data.user.username} (${data.user.uid})</p>
                        <p><strong>Found on ${data.devices.length} device(s):</strong></p>
                    `;
                    
                    // Populate device checkboxes
                    let devicesHtml = '';
                    data.devices.forEach(device => {
                        const statusIcon = device.status === 'online' ? 
                            '<i class="bi bi-circle-fill text-success"></i>' : 
                            '<i class="bi bi-circle-fill text-danger"></i>';
                        
                        devicesHtml += `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="deleteDevice_${device.hostname}" value="${device.hostname}" checked>
                                <label class="form-check-label" for="deleteDevice_${device.hostname}">
                                    ${statusIcon} ${device.hostname} (${device.status})
                                </label>
                            </div>
                        `;
                    });
                    
                    document.getElementById('deleteUserDevices').innerHTML = devicesHtml;
                    
                    // Show modal
                    new bootstrap.Modal(document.getElementById('deleteUserModal')).show();
                })
                .catch(error => {
                    console.error('Error loading user devices:', error);
                    alert('Error loading user devices');
                });
        }
        
        function confirmDeleteUser() {
            if (!currentDeleteUserId) return;
            
            // Get selected devices
            const selectedDevices = [];
            const checkboxes = document.querySelectorAll('#deleteUserDevices input[type="checkbox"]:checked');
            checkboxes.forEach(cb => selectedDevices.push(cb.value));
            
            if (selectedDevices.length === 0) {
                alert('Please select at least one device');
                return;
            }
            
            fetch(getApiUrl(`/api/users/${currentDeleteUserId}`), {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    devices: selectedDevices
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    let message = result.message + '\n\nDetails:\n';
                    result.results.forEach(res => {
                        message += `${res.device}: ${res.message}\n`;
                    });
                    alert(message);
                    
                    bootstrap.Modal.getInstance(document.getElementById('deleteUserModal')).hide();
                    loadUsers();
                }
            })
            .catch(error => {
                console.error('Error deleting user:', error);
                alert('Error deleting user');
            });
        }

        // Open door
        function openDoor(hostname) {
            fetch(getApiUrl('/api/doors/open'), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({device_hostname: hostname})
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert('Door opened successfully!');
                }
            })
            .catch(error => {
                console.error('Error opening door:', error);
                alert('Error opening door');
            });
        }

        // Refresh users from device
        function refreshUsers(hostname) {
            fetch(getApiUrl(`/api/devices/${hostname}/sync`), {
                method: 'POST'
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert('User sync requested for ' + hostname + '. Users will be updated automatically.');
                    // Refresh the users table after a short delay
                    setTimeout(() => {
                        loadUsers();
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error syncing users:', error);
                alert('Error requesting user sync');
            });
        }

        // Add system event
        function addSystemEvent(data) {
            const container = document.getElementById('system-events');
            const eventEntry = document.createElement('div');
            
            eventEntry.className = 'small mb-1 p-2 border-start border-2 border-info';
            eventEntry.innerHTML = `
                <div class="d-flex justify-content-between">
                    <strong>${data.topic}</strong>
                    <small>${new Date(data.timestamp).toLocaleString()}</small>
                </div>
                <pre class="mb-0 small">${JSON.stringify(data.payload, null, 2)}</pre>
            `;
            
            container.insertBefore(eventEntry, container.firstChild);
            
            // Keep only last 10 events
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        }

        // Edit user
        let currentEditUserId = null;
        function editUser(userId) {
            // Get user data
            fetch(getApiUrl(`/api/users`))
                .then(response => response.json())
                .then(users => {
                    const user = users.find(u => u.id === userId);
                    if (!user) {
                        alert('User not found');
                        return;
                    }
                    
                    currentEditUserId = userId;
                    document.getElementById('editUserName').value = user.username;
                    document.getElementById('editUserUID').value = user.uid;
                    document.getElementById('editUserDevice').value = user.device_hostname;
                    document.getElementById('editUserAccess').value = user.acctype;
                    
                    // Convert timestamps to datetime-local format
                    if (user.valid_since) {
                        const validFrom = new Date(user.valid_since * 1000);
                        document.getElementById('editValidFrom').value = validFrom.toISOString().slice(0, 16);
                    }
                    if (user.valid_until) {
                        const validUntil = new Date(user.valid_until * 1000);
                        document.getElementById('editValidUntil').value = validUntil.toISOString().slice(0, 16);
                    }
                    
                    new bootstrap.Modal(document.getElementById('editUserModal')).show();
                })
                .catch(error => {
                    console.error('Error loading user:', error);
                    alert('Error loading user data');
                });
        }

        // Update user
        function updateUser() {
            if (!currentEditUserId) return;
            
            const username = document.getElementById('editUserName').value;
            const acctype = document.getElementById('editUserAccess').value;
            const validFrom = document.getElementById('editValidFrom').value;
            const validUntil = document.getElementById('editValidUntil').value;
            
            if (!username) {
                alert('Please enter a username');
                return;
            }
            
            const data = {
                username: username,
                acctype: parseInt(acctype),
                valid_since: validFrom ? Math.floor(new Date(validFrom).getTime() / 1000) : 0,
                valid_until: validUntil ? Math.floor(new Date(validUntil).getTime() / 1000) : 0
            };
            
            fetch(getApiUrl(`/api/users/${currentEditUserId}`), {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                    loadUsers();
                    alert('User updated successfully!');
                }
            })
            .catch(error => {
                console.error('Error updating user:', error);
                alert('Error updating user');
            });
        }

        // Load devices for bulk assign
        function loadBulkAssignDevices() {
            fetch(getApiUrl('/api/devices'))
                .then(response => response.json())
                .then(devices => {
                    const container = document.getElementById('bulkDevicesList');
                    container.innerHTML = '';
                    
                    devices.forEach(device => {
                        const checkbox = document.createElement('div');
                        checkbox.className = 'form-check';
                        checkbox.innerHTML = `
                            <input class="form-check-input" type="checkbox" value="${device.hostname}" id="device_${device.hostname}">
                            <label class="form-check-label" for="device_${device.hostname}">
                                <strong>${device.hostname}</strong> 
                                <small class="text-muted">(${device.ip_address})</small>
                                <span class="badge ${device.status === 'online' ? 'bg-success' : 'bg-danger'} ms-2">${device.status}</span>
                            </label>
                        `;
                        container.appendChild(checkbox);
                    });
                    
                    // Set default datetime values for bulk assign
                    const now = new Date();
                    const nextYear = new Date(now.getTime() + 365 * 24 * 60 * 60 * 1000);
                    document.getElementById('bulkValidFrom').value = now.toISOString().slice(0, 16);
                    document.getElementById('bulkValidUntil').value = nextYear.toISOString().slice(0, 16);
                })
                .catch(error => console.error('Error loading devices:', error));
        }

        // Bulk assign user
        function bulkAssignUser() {
            const username = document.getElementById('bulkUserName').value;
            const uid = document.getElementById('bulkUserUID').value;
            const acctype = document.getElementById('bulkUserAccess').value;
            const validFrom = document.getElementById('bulkValidFrom').value;
            const validUntil = document.getElementById('bulkValidUntil').value;
            
            // Get selected devices
            const selectedDevices = [];
            const checkboxes = document.querySelectorAll('#bulkDevicesList input[type="checkbox"]:checked');
            checkboxes.forEach(cb => selectedDevices.push(cb.value));
            
            if (!username || !uid || selectedDevices.length === 0) {
                alert('Please fill in all required fields and select at least one device');
                return;
            }
            
            const data = {
                username: username,
                uid: uid,
                devices: selectedDevices,
                acctype: parseInt(acctype),
                valid_since: validFrom ? Math.floor(new Date(validFrom).getTime() / 1000) : 0,
                valid_until: validUntil ? Math.floor(new Date(validUntil).getTime() / 1000) : 0
            };
            
            fetch(getApiUrl('/api/users/bulk-assign'), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.results) {
                    let successCount = 0;
                    let errorCount = 0;
                    let message = 'Bulk assignment results:\n\n';
                    
                    result.results.forEach(res => {
                        if (res.status === 'success') {
                            successCount++;
                            message += `✓ ${res.device}: ${res.message}\n`;
                        } else {
                            errorCount++;
                            message += `✗ ${res.device}: ${res.message}\n`;
                        }
                    });
                    
                    message += `\nSummary: ${successCount} successful, ${errorCount} failed`;
                    alert(message);
                    
                    if (successCount > 0) {
                        bootstrap.Modal.getInstance(document.getElementById('bulkAssignModal')).hide();
                        document.getElementById('bulkAssignForm').reset();
                        loadUsers();
                    }
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error bulk assigning user:', error);
                alert('Error bulk assigning user');
            });
        }



        // Listen for user sync events
        socket.on('user_synced', function(data) {
            console.log('User synced:', data);
            // Refresh users table when a user is synced from device
            setTimeout(() => {
                loadUsers();
            }, 1000);
        });

        // Card detection events
        socket.on('card_detection_status', function(data) {
            console.log('Card detection status:', data);
            const statusText = document.getElementById('cardDetectionStatus');
            if (statusText) {
                statusText.textContent = data.message;
                statusText.className = data.active ? 'text-success' : 'text-muted';
            }
        });

        // Add User Modal Control
        document.addEventListener('DOMContentLoaded', function() {
            const addUserModal = document.getElementById('addUserModal');
            
            addUserModal.addEventListener('shown.bs.modal', function() {
                console.log('Add User modal opened - starting card detection');
                socket.emit('start_card_detection');
                loadAddUserDevices();
                loadHomeAssistantUsers();
            });
            
            addUserModal.addEventListener('hidden.bs.modal', function() {
                console.log('Add User modal closed - stopping card detection');
                socket.emit('stop_card_detection');
                // Clear form
                document.getElementById('addUserForm').reset();
                document.getElementById('userUID').value = '';
                
                // Uncheck all devices
                const checkboxes = document.querySelectorAll('#userDevicesList input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);
            });
        });

        // Load devices for Add User modal
        function loadAddUserDevices() {
            const devicesList = document.getElementById('userDevicesList');
            devicesList.innerHTML = '<div class="text-muted">Loading devices...</div>';
            
            fetch(getApiUrl('/api/devices'))
                .then(response => response.json())
                .then(devices => {
                    devicesList.innerHTML = '';
                    
                    if (devices.length === 0) {
                        devicesList.innerHTML = '<div class="text-muted">No devices available</div>';
                        return;
                    }
                    
                    devices.forEach(device => {
                        const checkboxDiv = document.createElement('div');
                        checkboxDiv.className = 'form-check';
                        checkboxDiv.innerHTML = `
                            <input class="form-check-input" type="checkbox" value="${device.hostname}" 
                                   id="device_${device.hostname}" name="devices">
                            <label class="form-check-label" for="device_${device.hostname}">
                                <strong>${device.hostname}</strong> 
                                <span class="text-muted">(${device.ip_address})</span>
                                <span class="badge bg-${device.status === 'online' ? 'success' : 'secondary'} ms-1">
                                    ${device.status}
                                </span>
                            </label>
                        `;
                        devicesList.appendChild(checkboxDiv);
                    });
                })
                .catch(error => {
                    console.error('Error loading devices:', error);
                    devicesList.innerHTML = '<div class="text-danger">Error loading devices</div>';
                });
        }

        // Load Home Assistant users for dropdown
        function loadHomeAssistantUsers() {
            const userSelect = document.getElementById('userName');
            
            fetch(getApiUrl('/api/homeassistant/users'))
                .then(response => response.json())
                .then(users => {
                    // Clear existing options except the first one
                    userSelect.innerHTML = '<option value="">Select Home Assistant User</option>';
                    
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.username;
                        option.textContent = `${user.name} (${user.username})`;
                        userSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading HA users:', error);
                    // Add fallback options if API fails
                    userSelect.innerHTML = `
                        <option value="">Select Home Assistant User</option>
                        <option value="admin">Administrator (admin)</option>
                        <option value="spase">Spase Micevski (spase)</option>
                        <option value="guest">Guest User (guest)</option>
                    `;
                });
        }

        // Toggle between dropdown and manual entry
        function toggleManualEntry() {
            const dropdown = document.getElementById('userName');
            const manualInput = document.getElementById('userNameManual');
            const isManual = dropdown.classList.contains('d-none');
            
            if (isManual) {
                // Switch to dropdown
                dropdown.classList.remove('d-none');
                manualInput.classList.add('d-none');
                manualInput.value = '';
                manualInput.removeAttribute('required');
                dropdown.setAttribute('required', '');
            } else {
                // Switch to manual input
                dropdown.classList.add('d-none');
                manualInput.classList.remove('d-none');
                dropdown.value = '';
                dropdown.removeAttribute('required');
                manualInput.setAttribute('required', '');
                manualInput.focus();
            }
        }

        // Get selected username (from dropdown or manual input)
        function getSelectedUsername() {
            const dropdown = document.getElementById('userName');
            const manualInput = document.getElementById('userNameManual');
            
            if (dropdown.classList.contains('d-none')) {
                return manualInput.value;
            } else {
                return dropdown.value;
            }
        }

        // Device filter change
        document.getElementById('device-filter').addEventListener('change', loadUsers);

        // Auto refresh data every 30 seconds
        setInterval(() => {
            loadDevices();
            loadAccessLogs();
        }, 30000);
    </script>
</body>
</html> 